<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>DIGIVEND ‚Äî Painel Admin</title>
  <link rel="stylesheet" href="style.css" />
  <!-- Chart.js via CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --bg: #0b0b0b;
      --card: #111;
      --accent: #e11;
      --white: #fff;
      --muted: #9aa0a6;
    }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--white);font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;}
    .page { max-width:1100px; margin:28px auto; padding:16px; }
    .header { display:flex; align-items:center; gap:12px; justify-content:space-between; margin-bottom:22px; }
    .logo { color:var(--accent); font-weight:800; font-size:20px; text-align:center; flex:1; }
    .top-right { display:flex; gap:10px; align-items:center; }
    .btn { background:transparent; border:1px solid #222; color:var(--white); padding:8px 12px; border-radius:8px; cursor:pointer; }
    .btn-red { background:var(--accent); border:none; color:#fff; }
    .cards { display:grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap:16px; margin-top:10px; }
    .card { background:var(--card); padding:18px; border-radius:12px; box-shadow:0 6px 18px rgba(0,0,0,0.6); text-align:center; min-height:110px; display:flex; flex-direction:column; justify-content:center; gap:8px; }
    .card h3{ margin:0; color:var(--accent); font-size:18px; }
    .card p{ margin:0; color:var(--white); font-size:22px; font-weight:700; }
    .card small{ color:var(--muted); display:block; margin-top:6px; }
    .quick-links { margin-top:18px; display:flex; gap:10px; justify-content:center; flex-wrap:wrap; }
    .center-note { text-align:center; color:var(--muted); margin-top:18px; }
    .chart-card { background:var(--card); border-radius:12px; padding:18px; margin-top:18px; box-shadow:0 6px 18px rgba(0,0,0,0.6); }
    .chart-card h3 { margin:0 0 12px 0; color:var(--accent); text-align:center; }
    footer { text-align:center; color:var(--muted); margin-top:26px; font-size:13px; }
    @media (max-width:520px){
      .header{flex-direction:column; align-items:stretch; gap:12px;}
      .logo{order:2}
    }
  </style>
</head>
<body>
  <div class="page">
    <div class="header" role="banner">
      <div class="left">
        <button class="btn" onclick="openMenu()">‚ò∞</button>
      </div>
      <div class="logo">DIGIVEND ‚Äî ADMIN</div>
      <div class="top-right">
        <button class="btn" id="btnRefresh" title="Atualizar" onclick="carregarDashboard()">‚ü≥ Atualizar</button>
        <div id="adminLabel">üë§ Admin</div>
        <button class="btn" onclick="logout()">Sair</button>
      </div>
    </div>

    <h2 style="text-align:center; color:var(--accent); margin:6px 0 0 0">Resumo Administrativo</h2>

    <section class="cards" aria-live="polite" id="cardsContainer">
      <div class="card">
        <h3>üë• Usu√°rios</h3>
        <p id="countUsers">‚Äî</p>
        <small>Total cadastrados</small>
      </div>
      <div class="card">
        <h3>üì¶ Produtos</h3>
        <p id="countProducts">‚Äî</p>
        <small>Pendentes para aprova√ß√£o</small>
      </div>
      <div class="card">
        <h3>üíµ Saques</h3>
        <p id="countWithdrawals">‚Äî</p>
        <small>Solicita√ß√µes pendentes</small>
      </div>
      <div class="card">
        <h3>üí∞ Comiss√£o (total)</h3>
        <p id="platformCommissions">‚Äî</p>
        <small>Comiss√£o da plataforma em vendas</small>
      </div>
      <div class="card">
        <h3>üè¶ Taxas de Saque</h3>
        <p id="withdrawFees">‚Äî</p>
        <small>Taxas recebidas</small>
      </div>
      <div class="card">
        <h3>üìà Ganhos da Plataforma</h3>
        <p id="platformTotal">‚Äî</p>
        <small>Comiss√£o + Taxas</small>
      </div>
    </section>

    <div class="quick-links">
      <button class="btn btn-red" onclick="goTo('admin_users.html')">Gerenciar Usu√°rios</button>
      <button class="btn btn-red" onclick="goTo('admin_produtos.html')">Gerenciar Produtos</button>
      <button class="btn btn-red" onclick="goTo('admin_saques.html')">Gerenciar Saques</button>
      <button class="btn" onclick="goTo('admin_relatorios.html')">Relat√≥rios</button>
    </div>

    <!-- Gr√°fico -->
    <section class="chart-card">
      <h3>Ganhos da Plataforma (√∫ltimos 6 meses)</h3>
      <canvas id="graficoGanhos" height="110"></canvas>
    </section>

    <div class="center-note">
      <small>Fontes: JSON Server (se ativo) ‚Üí <code>http://localhost:3000</code> ‚Äî fallback para LocalStorage caso n√£o haja backend.</small>
    </div>

    <footer>DIGIVEND ‚Ä¢ Painel Administrativo</footer>
  </div>

  <script>
    // Prote√ß√£o de rota: somente admin
    (function protect(){
      try {
        const usuario = JSON.parse(localStorage.getItem("usuarioLogado"));
        if (!usuario || usuario.tipo !== "admin") {
          alert("Acesso negado ‚Äî fa√ßa login como administrador.");
          window.location.href = "login.html";
          return;
        }
        if (usuario && usuario.email) {
          document.getElementById("adminLabel").innerText = "üë§ " + usuario.email;
        }
      } catch(e) {
        console.error(e);
        window.location.href = "login.html";
      }
    })();

    function formatBRL(n){
      return "R$ " + Number(n||0).toFixed(2);
    }

    async function safeFetchJson(url){
      try {
        const controller = new AbortController();
        const id = setTimeout(()=>controller.abort(), 2500);
        const res = await fetch(url, { signal: controller.signal });
        clearTimeout(id);
        if (!res.ok) throw new Error("fetch failed");
        return await res.json();
      } catch (err) {
        return null;
      }
    }

    async function carregarDashboard(){
      document.getElementById("countUsers").innerText = "‚Ä¶";
      document.getElementById("countProducts").innerText = "‚Ä¶";
      document.getElementById("countWithdrawals").innerText = "‚Ä¶";
      document.getElementById("platformCommissions").innerText = "‚Ä¶";
      document.getElementById("withdrawFees").innerText = "‚Ä¶";
      document.getElementById("platformTotal").innerText = "‚Ä¶";

      const API = "http://localhost:3000";
      const [usuariosAPI, produtosAPI, transacoesAPI] = await Promise.all([
        safeFetchJson(API + "/usuarios"),
        safeFetchJson(API + "/produtos"),
        safeFetchJson(API + "/transacoes")
      ]);

      // Usu√°rios
      let usersCount = 0;
      if (usuariosAPI) usersCount = usuariosAPI.length;
      else usersCount = (JSON.parse(localStorage.getItem("usuarios")||"[]")).length;
      document.getElementById("countUsers").innerText = usersCount;

      // Produtos pendentes
      let pendingProducts = 0;
      if (produtosAPI) pendingProducts = produtosAPI.filter(p => (p.status||"").toLowerCase().includes("pend")).length;
      else pendingProducts = (JSON.parse(localStorage.getItem("produtosPendentes")||"[]")).length;
      document.getElementById("countProducts").innerText = pendingProducts;

      // Transa√ß√µes ‚Üí calcular comiss√µes e taxas
      let trans = [];
      if (transacoesAPI) trans = transacoesAPI;
      else trans = JSON.parse(localStorage.getItem("transacoes")||"[]");

      // Regras: comiss√£o plataforma (%) e taxa de saque (fixo/%) ‚Äî simuladas
      const COMISSAO_PLATAFORMA = Number(localStorage.getItem("cfg_comissao") || 0.10); // 10%
      const TAXA_SAQUE_FIXA   = Number(localStorage.getItem("cfg_taxa_saque_fixa") || 2.00); // R$2,00
      const TAXA_SAQUE_PCT    = Number(localStorage.getItem("cfg_taxa_saque_pct")  || 0.00); // 0% (pode mudar)

      let totalComissoes = 0;
      let totalTaxasSaque = 0;

      (trans||[]).forEach(t=>{
        const tipo = (t.tipo || t.type || "").toLowerCase();
        const status = (t.status || "").toLowerCase();
        const valor = Number(t.valor || 0);

        if (status.includes("concl") || status.includes("pago") || !status) {
          if (tipo.includes("venda")) {
            totalComissoes += valor * COMISSAO_PLATAFORMA; // tua parte
          }
          if (tipo.includes("saque")) {
            totalTaxasSaque += TAXA_SAQUE_FIXA + (valor * TAXA_SAQUE_PCT);
          }
        }
      });

      const totalPlataforma = totalComissoes + totalTaxasSaque;

      document.getElementById("platformCommissions").innerText = formatBRL(totalComissoes);
      document.getElementById("withdrawFees").innerText = formatBRL(totalTaxasSaque);
      document.getElementById("platformTotal").innerText = formatBRL(totalPlataforma);

      // Gr√°fico: ganhos √∫ltimos 6 meses (s√≥ cor branca)
      const series = montarSerie6Meses(trans, COMISSAO_PLATAFORMA, TAXA_SAQUE_FIXA, TAXA_SAQUE_PCT);
      desenharGrafico(series.labels, series.data);
    }

    function montarSerie6Meses(trans, pctComissao, taxaSaqueFixa, taxaSaquePct){
      const hoje = new Date();
      const labels = [];
      const mapa = new Map(); // key: YYYY-MM, value: total plataforma

      // Inicializa √∫ltimos 6 meses com 0
      for (let i=5;i>=0;i--){
        const d = new Date(hoje.getFullYear(), hoje.getMonth()-i, 1);
        const key = d.getFullYear()+"-"+String(d.getMonth()+1).padStart(2,"0");
        labels.push(mesPtCurto(d.getMonth())+"/"+String(d.getFullYear()).slice(2));
        mapa.set(key, 0);
      }

      (trans||[]).forEach(t=>{
        const dt = t.data ? new Date(t.data) : new Date();
        const key = dt.getFullYear()+"-"+String(dt.getMonth()+1).padStart(2,"0");
        if (!mapa.has(key)) return; // ignora meses fora da janela

        const tipo = (t.tipo || t.type || "").toLowerCase();
        const status = (t.status || "").toLowerCase();
        const valor = Number(t.valor || 0);

        if (status && !status.includes("concl") && !status.includes("pago")) return;

        let atual = mapa.get(key)||0;
        if (tipo.includes("venda")) {
          atual += valor * pctComissao;
        }
        if (tipo.includes("saque")) {
          atual += taxaSaqueFixa + (valor * taxaSaquePct);
        }
        mapa.set(key, atual);
      });

      const data = Array.from(mapa.values()).map(v=>Number(v.toFixed(2)));

      // Se tudo zero e n√£o h√° transa√ß√µes, popula exemplo suave
      if (!trans || trans.length===0 || data.every(v=>v===0)){
        return {
          labels,
          data: [120, 180, 90, 210, 160, 240] // exemplo
        };
      }

      return { labels, data };
    }

    function mesPtCurto(m){
      const nomes = ["Jan","Fev","Mar","Abr","Mai","Jun","Jul","Ago","Set","Out","Nov","Dez"];
      return nomes[m] || "";
    }

    let chartInstance = null;
    function desenharGrafico(labels, data){
      const ctx = document.getElementById('graficoGanhos').getContext('2d');
      if (chartInstance) { chartInstance.destroy(); }
      chartInstance = new Chart(ctx, {
        type: 'line',
        data: {
          labels,
          datasets: [{
            label: 'Ganhos da Plataforma',
            data,
            borderColor: '#ffffff',        // linha branca
            backgroundColor: 'rgba(255,255,255,0.10)', // preenchimento suave (branco transl√∫cido)
            pointBackgroundColor: '#ffffff',
            pointBorderColor: '#ffffff',
            tension: 0.3
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { labels: { color: '#ffffff' } },
            tooltip: { titleColor: '#ffffff', bodyColor: '#ffffff', backgroundColor: '#000' }
          },
          scales: {
            x: {
              ticks: { color: '#ffffff' },
              grid: { color: 'rgba(255,255,255,0.2)' }
            },
            y: {
              ticks: { color: '#ffffff' },
              grid: { color: 'rgba(255,255,255,0.2)' }
            }
          }
        }
      });
    }

    function goTo(page){ window.location.href = page; }
    function logout(){ localStorage.removeItem("usuarioLogado"); window.location.href = "login.html"; }
    function openMenu(){ const el = document.getElementById('sideMenu'); if (el) el.style.width = el.style.width === '250px' ? '0' : '250px'; }

    // Inicializa
    carregarDashboard();
  </script>
</body>
</html>
